name: Daily Check
on:
  schedule:
    - cron: '0 15 * * *'  # 00:00 JST (15:00 UTC)
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'
    - name: Set timezone environment variable to JST
      run: |
        echo "TZ=Asia/Tokyo" >> $GITHUB_ENV
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        sudo apt-key adv --apt-get-install --yes install apt-transport-https
        sudo apt-get update
        sudo apt-get install -y gh  
    - name: Check and update daily-check.json
      id: update-json
      run: |
        now=$(date --iso-8601=seconds)
        if [ ! -f daily-check.json ]; then
          echo '{"day": "'$now'", "error": 0}' > daily-check.json
        else
          error_count=$(gh issue list --state open --repo ${{ github.repository }} | wc -l)
          jq --arg now "$now" --arg error "$error_count" '.day = $now | .error = ($error|tonumber)' daily-check.json > tmp.json && mv tmp.json daily-check.json
        fi
        echo "errors=$(jq '.error' daily-check.json)" >> $GITHUB_ENV
    - name: Set up Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    - name: Create and push branch
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git
        git checkout -b update-daily-check
        git add daily-check.json
        git commit -m 'Update daily-check.json'
        git push -u origin update-daily-check
    - name: Create Pull Request
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        gh auth login --with-token <<< "${{ secrets.GH_TOKEN }}"
        gh pr create --base main --head update-daily-check --title "Update daily-check.json" --body "Auto-updated daily-check.json"
    - name: Merge Pull Request
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        pr_number=$(gh pr list --state open --head update-daily-check --json number --jq '.[0].number')
        gh pr merge $pr_number --squash --merge
    - name: Notify Discord if errors found
      if: ${{ env.errors != 0 }}
      run: |
        curl -X POST -H "Content-Type: application/json" -d "{\"content\": \"Open issues found: ${{ env.errors }}\"}" ${{ secrets.ERROR_DISCORD_WEBHOOK }}